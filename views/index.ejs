<% layout('layout') -%>
    <div class="wrapper">
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="/">Main</a>
        </li>
        <li class="nav-item">
            <a class="nav-link disabled" href="/">Chat</a>
        </li>
        <li class="nav-item">
            <a class="nav-link link-secondary" href="/settings">Settings</a>
        </li>
    </ul>
    <div class="ms-5">
        <div class="card-header">
            What is going on:
        </div>
        <form action="/create-post" id="postForm" method="post" enctype="multipart/form-data" class="mx-2">
            <p class=" text-info">Post your own story</p>
            <textarea name="Content" id="textArea" cols="50"required></textarea><br>
            
            <label for="Image">Picture(if needed):</label>
            <input type="file" name="file" id="Image" accept="image/*" class="form-control"><br>
            <input type="submit" value="Post!" id="inputBtn" class="btn btn-success text-center">

        </form>
        <hr>
        <div class="card">
            <ol class="list-group list-group-flush" reversed>
            <p class="text-muted mx-5">tip: If you don't see images, reload the page or wating them to load. </p>
                <% let formNum=0 %>
                    <% Posts.forEach(Post=> { %>
                        <% formNum +=1 %>
                            <li class="list-group-item">
                                <div class="card">
                                    <div class="card-header">
                                        <p><a href="/user/<%= Post.Owner%>"><%- Post.Owner%></a></p>
                                            <% if (User.Username===Post.Owner || User.Username==="admin" ) { %>
                                                <form action="/remove-post" method="post" id="deleteForm">
                                                    <input type="hidden" name="id" value='<%= Post._id %>'>
                                                    <input type="submit" class="btn btn-danger text-end" value="delete"
                                                        id="inputDelete">
                                                </form>
                                                <% } %>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">
                                            <%- Post.Body %>
                                                <% if (Post.Image.length>0) { %>
                                                    <br>
                                                    <picture>
                                                        <img src="https://express-app.ultimatecode.repl.co/images/<%= Post.Image[0].filename%>"
                                                            onerror="this.onerror=null; this.src='https://http.cat/204'; this.title='No image was found, maybe image got deleted or expired. Images can be alive for only 3 months before expired/deleted.'" 
                                                            width="200rem">
                                                    </picture>
                                                    <% } %>
                                        </p>
                                        <%let totalReplies = 0%>
                                        <%Post.Comments.forEach(Comment=>{%>
                                          <%totalReplies += Comment.replies.length%>
                                        <%})%>
                                        <div class="card-footer text-muted">
                                            <form action="/create-comment" method="post" id="comment-form<%= formNum%>">

                                                <input type="hidden" value="<%= Post._id %>" name="id">
                                                <input type="text" name="Content" id="Content" maxlength="40"
                                                    required><input type="submit" value="Comment" id="commentPost">
                                                <input type="button" class="btn btn-outline-primary"
                                                    value="Show Comments" id="showComment"><p class="text-primary">(<%= Post.Comments.length%>) Comments and (<%=totalReplies%>) Replies in total</p>
                                            </form>

                                            <div id="comment_space" hidden="hidden">
                                                <ul class="list-group">
                                                    <% let num=0 %>
                                                    
                                                        <% Post.Comments.forEach(Comment=> { %>
                                                            <% num +=1 %>
                                                                <div class="card">
                                                                    <div class="card-body">
                                                                        <h5 class="card-title">
                                                                        <p><a href="/user/<%= Comment.Owner%>"><%- Comment.Owner%></a></p>
                                                                                <% if (User.Username===Post.Owner ||
                                                                                    User.Username==="admin" ) { %>
                                                                                    <form action="/remove-comment"
                                                                                        method="post" id="deleteForm">
                                                                                        <input type="hidden" name="id"
                                                                                            value='<%= Post._id %>'>
                                                                                        <input type="hidden"
                                                                                            name="index"
                                                                                            value='<%= num %>'>
                                                                                        <input type="submit"
                                                                                            class="btn btn-danger text-end"
                                                                                            value="delete"
                                                                                            id="inputDelete">
                                                                                    </form>
                                                                                    <% } %>
                                                                        </h5>
                                                                        <p class="card-text">
                                                                           <%- Comment.Content %> 
                                                                        </p>
                                                                        <div class="card-footer text-muted">
                                                                            <form action="/create-reply" method="post"
                                                                                id="comment-form<%= formNum%>">

                                                                                <input type="hidden"
                                                                                    value="<%= Post._id %>" name="id">
                                                                                <input type="hidden" name="index"
                                                                                    value="<%= num %>">
                                                                                <input type="text" name="Content"
                                                                                    id="Content" maxlength="40"
                                                                                    required><input type="submit"
                                                                                    value="Comment" id="replyPost">
                                                                                <input type="button"
                                                                                    class="btn btn-outline-primary"
                                                                                    value="Show Replies"
                                                                                    id="showReplies"><p class="text-primary">(<%= Comment.replies.length%>) Replies</p>
                                                                            </form>
                                                                            <div id="RepliesSpace" hidden="hidden">
                                                                                <% let replyNum=0%>
                                                                                    <%Comment.replies.forEach(Reply=>
                                                                                        {%>
                                                                                        <% replyNum +=1%>
                                                                                            <div class="card">
                                                                                                <div class="card-body">
                                                                                                    <h5
                                                                                                        class="card-title">
                                                                                                        <p><a href="/user/<%= Reply.Owner%>"><%- Reply.Owner%></a></p>
                                                                                                            <% if
                                                                                                                (User.Username===Reply.Owner
                                                                                                                ||
                                                                                                                User.Username==="admin"
                                                                                                                ) { %>
                                                                                                                <form
                                                                                                                    action="/remove-reply"
                                                                                                                    method="post"
                                                                                                                    id="deleteForm">
                                                                                                                    <input
                                                                                                                        type="hidden"
                                                                                                                        name="id"
                                                                                                                        value='<%= Post._id %>'>
                                                                                                                    <input
                                                                                                                        type="hidden"
                                                                                                                        name="replyId"
                                                                                                                        value='<%= Reply._id %>'>
                                                                                                                    <input
                                                                                                                        type="hidden"
                                                                                                                        name="commentIndex"
                                                                                                                        value="<%= num%>">
                                                                                                                    <input
                                                                                                                        type="submit"
                                                                                                                        class="btn btn-danger text-end"
                                                                                                                        value="delete"
                                                                                                                        id="inputDelete">
                                                                                                                </form>
                                                                                                                <% } %>
                                                                                                    </h5>
                                                                                                    <p
                                                                                                        class="card-text">
                                                                                                        <%-
                                                                                                            Reply.Content%> &gt;
                                                                                                    </p>
                                                                                                </div>
                                                                                            </div>
                                                                                            <%});%>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <% }); %>
                                                </ul>

                                            </div>
                                        </div>


                                    </div>
                                </div>
                            </li>
                            <% }); %>
            </ol>
        </div>

        <style>
            ol {
                display: flex;
                flex-direction: column-reverse;
            }

            li {
                flex: 0 0 auto;
            }
        </style>
    </div>
    </div>
    <script src="/JavaScript/Posts.js">
        
        
    </script>
    <% block('js', `<script>
        
        </script>`) -%>